##  Обзор и тестирование семейства контроллеров PY32F002A,F003,F030

### Введение
Данные чипы построены на одном кристалле и имеют все свойства старшей модели PY32F030. Ограничение есть только на возможности назначения функций на существующие порты в корпусе. 
(например управление LED сегментными индикаторами возможно только в корпусах 32pin - а это только PY32F030)<br>

Вся внутренняя переферия
```
LSI - 32.768kHz
LSE - 0-1000kHz  (F030: lqfp32, qfn32, tssop20 pinout1 )
HSI - 4,8,16,22.12,24MHz (есть калибровочные константы)
HSE - 4-32MHz
PLL - x2 (from HSI or HSE)
DMA - 3ch, IWDG, WWDG, SysTick, RTC
Timers (16b): Adv:1, GP:4, LP:1, 
2x USART, 2х SPI, 1x I2C
ADC 12bit (10+2ch) (1Msps), 2x Comp
Max Frequency: 48MHz
1.7 - 5.5 V
Hardware CRC-32 module
Support 4-digit 8-segment common-cathode LED digital tube (F030)
```

Дополнительные сведения по серии из [Factory Config](./bootloader/README.md)

####  !!!   ВСЕ ПРОЕКТЫ можно делать с шаблоном PY32F030x6 или PY32F030x8 

// для F002A - используем шаблон PY32F030x6<br>
// и это охватывает почти все варианты, учитывая что 16K/2K очень мало чипов

### Ревизии

На данный момент есть две ревизии - 'B' и 'E'<br>
номер на чипе в последней строке, последняя буква  'B' или 'E'<br>
на демоплате embedfire как раз стоит PY32F030EK28U6<br>
что даже отражено в наименовании<br>
  
<img src="./images/F030EK28U6.png" alt="drawing" width="400"/>

Единственное отличие отличие по DS:<br>
PLL_IN - только 24 MHz<br>
В ревизии 'B':  16 - 24 MHz

### Корпуса
```
lqfp32        - F030 ( 1,2 pinouts )
qfn32(5x5)    - F030 ( 2,3 pinouts )
qfn32(4x4)    - F030 ( 4 pinout )
qfn24(3x3)    - F030 ( 1 pinout )
ssop24        - F030 ( 1,2 pinouts )
qfn20(3x3)    - F030 ( 1,2,3 pinouts ); F003 ( 1,2 pinouts ); F002A ( 1 pinout )   
tssop20       - F030 ( 1,2,3,4 pinouts ); F003 ( 1,2,3,4,5,6 pinouts ); F002A ( 1 pinout )      
sop20         - F003 ( 1 pinout )    
qfn16(3x3)    - F002A ( 1 pinout )  
sop16         - F003 ( 1 pinout ); F002A ( 1 pinout )      
msop10        - F003 ( 1 pinout ); F002A ( 1 pinout )    
essop10       - F002A ( 1 pinout )  
sop8          - F003 ( 1,2 pinouts ); F002A  ( 1 pinout )   
dfn8(3x2)     - F003 ( 1 pinout )  
dfn8(1.5x1.5) - F030 ( 1 pinout )  

lqfp32      e=0.8
qfn32(5x5)  e=0.5;  qfn32(4x4)  e=0.4
ssop24      e=0.635
qfn16(3x3)  e=0.5;  qfn20(3x3)  e=0.4;  qfn24(3x3) e=0.35  
tssop20     e=0.65
msop10      e=0.5;  essop10  e=1.0
dfn8(3x2)   e=0.5;  dfn8(1.5x1.5)  e=0.4
sop8,16,20  e=1,27
```
// разводка выводов (pinout) <br>
// определяется цифрой после буквы количества выводов<br>
// PY32F030K<b>2</b>8T6 - 2-ой pinout<br>
//   в основном все разводки разные<br>
//   совпадают  PY32F030F2xPx = PY32F003F1xPx - tssop20<br>
//   совпадают  PY32F030F2xUx = PY32F003F1xUx - qfn20<br>
//   совпадают  PY32F030F1xUx = PY32F003F2xUx - qfn20<br>

<img src="./images/puya_py32f0xx.png" alt="drawing" width="400"/>


### Демоплаты
```
1. EmbedFire PY32F030K28U6TR  ( стоит PY32F030EK28U6 rev.E )
   LED1      - Power
   LED2,3,4  - PA2,3,4
   Key RST   - Reset (PF4)
   KEY1,2    - PA5,6
   HSE       - 24 MHz (PF0,1)
   LSE       - opt (PA9,10)
   I/O       - 26 (PA0-8,PA11-15,PB0-8,PF2-4) 
```

<img src="./images/embedfire_f030.png" alt="drawing" width="400"/>


### Ремапинг 

Очень богатый выбор ремапинга функций портов (альтернативные функции)<br>
Индивидуально можно настроить каждый пин.<br>
Шаблон возможных вариантов [REMAP](./ReMapIO/remap_pin_py32f0xx.xlsx) <br>

Учитывая одинаковый кристалл внутри данного семейства имеем всего 30 i/o<br>
и все возможные варианты альтернативных функций<br>
Как пример: приведен расклад<br>  
2x full SPI + 2x USART + 3 i/o - для PY32F002AW15U6 (qfn16 3x3)<br>

### Программаторы (Windows 10)

1. ST-Link V2
```
Keil  - работает без проблем
pyocd - в основном работает (кроме режима стирания при Reset или подаче питания) 
```

2. J-Link OB (из BluePill STM32F103)
```
Keil  - работает, только требуется добавить описание контроллеров
        в папку <USER>\AppData\Roaming\SEGGER\JLinkDevices\ 
        распаковать архив  [Puya](./J-Link/Puya.7z)
        ( настройки для F030x6, F030x8, F002B(это чуть другое семейство))
Py32CubeProgrammer - работает
pyocd  - совсем не работает и при любой команде убивается клон J-Link 
```

3. CMSIS-DAP  (2 варианта  WCH-LinkE и  SLogic Combo)
```
Keil  - работает, только есть ошибка при стирании чипа, 
        но чип стирается, а заливка не проходит
        если разделить стирание - отдельно, 
        заливка (без стирания) - отдельно
        то всё нормально! 
pyocd  - прошивка стирание - работает и даже при подаче питания стрить можно        
openocd - пробовал подключать с WCH-LinkE (чип читал пока только)
          openocd - редакция от Puya !
```

4. UART (ISP)
```
Проверено только в Py32CubeProgrammer
пары выводов для UART (PA2,3; PA9,10; PA14,15)
обязательно Boot0='1' (только tssop20,qfn32,lqfp32)
на PY32F030K28T6 - только получилось на PA14,15
на PY32F030EK28U6 (демоплата) - PA2,PA3 и PA14,15 - работает // (PA9,10 - для опц. LSE и не выведены) 
```

### Утилиты 

1. Py32CubeProgrammer
```
```

2. pyocd
```
для работы с pyocd нужны файл конфигурации и пакет DFP
// в папке  pyocd  выложенены необходимые файлы
```

3. openocd - в процессе изучения 




### IDE

1. Keil
    нормально можно работать, учитывая отладчик встроенный<br>
    и поддерживающий разные варианты подключаемых программаторов<br>
    (минус - библиотека DFP 1.2.8 с ошибкой при создании нового проекта<br>
    для F030 добавляется два комплекта стартап файлов для F030 и F031)<br>
2. Eclipse
    при создании проекта статртап файлы не добавляются (может чего не донастроено)<br>
    при настройке вручную - всё работает.
3. IAR -
    В процессе изучения
4. VSCode + PlatformIO -
    В процессе изучения

### Интересные тесты

#### Проверка что это один и тот-же кристалл

В отладчике и программаторах реально читается 32K Flash и 4K RAM для PY32F002A<br>
Проверено - что PLL запускается на 48MHz на чипах PY32F002A и PY32F003<br>

#### Прошивка с ошибкой - как тест сброса контроллера

Случайно сделал прошивку с ошибкой<br>
== Назначение PLL как SYSCLK, когда PLL не запущен<br>
В данном режиме программаторы не видят чип (или видят но не могут ничего сделать)<br>
При использовании данной прошивки как тестовой - получилось<br>
(pyocd)<br>
= стирание памяти при Reset, но кроме чипа PY32F030EK28U6 (на демоплате embedfire).<br>
= данный чип удалось стереть только при подаче питания и<br>
(Py32CubeProgrammer)<br>
= подключение по UART при Boot0-"1" - чип можно перепрограммировать (ISP)<br>

#### Стирание прошивки (сброс) при использовании служебных выводов (SWC,SWD,NRST)

Исходя из прошивки с ошибкой - проведён тест по использованию "всех" портов<br>
на порты с служебными функциями назначены были вывод меандра (LED blink)<br>
SWC,SWD,NRST (предварительно NRST переведён в режим GPIO)<br>

После прошивки данный чип недоступен для подключения программаторами<br>
Проведён тест с помощью pyocd стереть чип при подаче питания<br>
== Успешно == (только CMSIS-DAP) //  с настоящим J-Link - тоже должно работать<br> 

Если есть вывод Boot0 и он используется как вход, то<br>
Py32CubeProgrammer - подключение по UART при Boot0-"1" - чип можно перепрограммировать<br>
